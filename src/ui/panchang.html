<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panchanga and Muhurta</title>
    <!-- Vue.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- Vuetify CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <!-- Font Awesome CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Inter font for a modern look -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
        /* Light grey background */
        display: flex;
        justify-content: center;
        align-items: flex-start;
        /* Align to top initially */
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      #app {
        max-width: 900px;
        width: 100%;
        margin-top: 50px;
        /* Add some top margin for better visual spacing */
        padding-bottom: 60px;
        /* Space for the sticky footer */
      }

      .v-card {
        border-radius: 12px !important;
        /* Rounded corners for cards */
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08) !important;
        /* Soft shadow */
      }

      .v-btn {
        border-radius: 8px !important;
        /* Rounded buttons */
        text-transform: none !important;
        /* Keep button text as is */
        font-weight: 600 !important;
      }

      .v-text-field--outlined fieldset {
        border-radius: 8px !important;
        /* Rounded borders for text fields */
      }

      .v-application {
        background-color: transparent !important;
        /* Ensure app background is transparent */
      }

      .v-main__wrap {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      .info-card .v-card__title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        display: flex;
        /* Allow icon and text to be on same line */
        align-items: center;
      }

      .info-card .v-card__title .v-icon {
        margin-right: 8px;
        /* Space between icon and title text */
      }

      .info-card .v-card__text {
        font-size: 1rem;
        color: #555;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .time-span-card {
        background-color: #e3f2fd !important;
        /* Light blue background for time span cards */
        border: 1px solid #90caf9 !important;
      }

      .time-span-card .v-card__title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1976d2;
        display: flex;
        align-items: center;
      }

      .time-span-card .v-card__title .v-icon {
        margin-right: 8px;
      }

      /* New style for vertical arrangement of time spans */
      .time-spans-list {
        display: flex;
        flex-direction: column;
        /* Arrange items vertically */
        gap: 15px;
        /* Spacing between cards */
        margin-top: 20px;
      }

      /* Style for inauspicious time cards */
      .inauspicious-card {
        background-color: #ffebee !important;
        /* Light red background */
        border: 1px solid #ef9a9a !important;
        /* Red border */
      }

      .inauspicious-card .v-card__title,
      .inauspicious-card .v-card__text {
        color: #c62828 !important;
        /* Darker red text */
      }

      /* Sticky warning alert */
      .sticky-alert {
        position: sticky;
        top: 20px;
        /* Adjust as needed for desired spacing from top */
        z-index: 1000;
        /* Ensure it stays on top of other content */
        width: 100%;
        max-width: 900px;
        /* Match app max-width */
        margin: 0 auto 20px auto;
        /* Center and add bottom margin */
      }

      .greyed-out-text {
        color: #a0a0a0 !important;
        /* A lighter grey for repeated values */
      }
    </style>
    <script src="webui.js"></script>
  </head>

  <body>
    <div id="app">
      <v-app>
        <v-main>
          <v-container>
            <!-- Sticky Warning Alert -->
            <v-alert
              v-if="showMoshierWarning"
              type="warning"
              dismissible
              class="sticky-alert"
              transition="slide-y-transition"
              prominent
              border="left"
            >
              <strong>Warning:</strong> Swiss ephemeris data not found on your
              system. The less accurate Moshier ephemeris will be used for
              calculations. <br /><br />
              Please copy-paste this link into your browser to download a zip
              file: <br />
              https://github.com/aloistr/swisseph/archive/refs/heads/master.zip
              <br />
              Extract it, and copy the "ephe" folder to the same location as
              this program executable.
            </v-alert>

            <!-- Sticky Error Alert -->
            <v-alert
              v-if="showError"
              type="danger"
              dismissible
              class="sticky-alert"
              transition="slide-y-transition"
              prominent
              border="left"
            >
              <v-icon left>fa-solid fa-triangle-exclamation</v-icon>
              <strong>Error:</strong> Something went wrong and the requested
              action failed.
            </v-alert>

            <v-card class="pa-6 mb-8" elevation="4">
              <v-card-title class="headline text-center justify-center mb-4">
                <v-icon left class="mr-2">fa-solid fa-om</v-icon>
                Panchanga and Muhurta
              </v-card-title>
              <v-card-text class="py-0">
                <!-- Reduced vertical padding -->
                <!-- City Input Field -->
                <v-row dense>
                  <!-- Use dense for smaller row height -->
                  <v-col cols="12">
                    <v-text-field
                      v-model="cityName"
                      label="City Name (e.g., Pune)"
                      outlined
                      dense
                      append-icon="fa-solid fa-city"
                      @click:append="fetchCoordinatesForCity"
                      @keyup.enter="fetchCoordinatesForCity"
                      hide-details="auto"
                    ></v-text-field>
                  </v-col>
                </v-row>
                <v-row dense class="mb-4">
                  <!-- Reduced bottom margin -->
                  <v-col cols="12" class="d-flex justify-center">
                    <v-btn
                      color="secondary"
                      small
                      @click="fetchCoordinatesForCity"
                      :loading="loadingCoordinates"
                      :disabled="!cityName"
                    >
                      <v-icon left>fa-solid fa-location-dot</v-icon>
                      Find Coordinates
                    </v-btn>
                  </v-col>
                </v-row>

                <!-- Display found place name -->
                <v-alert
                  v-if="foundPlaceName"
                  type="info"
                  text
                  dense
                  class="mt-2 mb-4"
                >
                  Coordinates found for: <strong>{{ foundPlaceName }}</strong>
                </v-alert>

                <v-divider class="my-4"></v-divider>

                <!-- Latitude and Longitude Input Fields -->
                <v-row dense>
                  <v-col cols="12" md="4">
                    <v-text-field
                      v-model="latitude"
                      label="Latitude"
                      outlined
                      dense
                      placeholder="e.g., 34.0522"
                      type="number"
                      :rules="[rules.required, rules.number]"
                      hide-details="auto"
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12" md="4">
                    <v-text-field
                      v-model="longitude"
                      label="Longitude"
                      outlined
                      dense
                      placeholder="e.g., -118.2437"
                      type="number"
                      :rules="[rules.required, rules.number]"
                      hide-details="auto"
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12" md="4">
                    <v-text-field
                      v-model="timezone"
                      label="Timezone (e.g., 5.5 for IST)"
                      outlined
                      dense
                      placeholder="e.g., 5.5"
                      type="number"
                      :rules="[rules.required, rules.number]"
                      hide-details="auto"
                    ></v-text-field>
                  </v-col>
                </v-row>

                <v-tabs
                  v-model="activeTab"
                  background-color="transparent"
                  color="primary"
                  grow
                  class="mt-4"
                >
                  <v-tab>
                    <v-icon left>fa-solid fa-calendar-day</v-icon>
                    Daily Panchanga
                  </v-tab>
                  <v-tab>
                    <v-icon left>fa-solid fa-calendar-alt</v-icon>
                    Muhurta Search
                  </v-tab>
                </v-tabs>

                <v-tabs-items v-model="activeTab" class="mt-4">
                  <v-tab-item>
                    <!-- Single Day Inputs -->
                    <v-row dense class="mt-5">
                      <v-col cols="12">
                        <v-menu
                          v-model="dateMenu"
                          :close-on-content-click="false"
                          transition="scale-transition"
                          offset-y
                          min-width="auto"
                        >
                          <template v-slot:activator="{ on, attrs }">
                            <v-text-field
                              v-model="selectedDate"
                              label="Select Date"
                              prepend-icon="fa-solid fa-calendar-days"
                              readonly
                              outlined
                              dense
                              v-bind="attrs"
                              v-on="on"
                              :rules="[rules.required]"
                              hide-details="auto"
                            ></v-text-field>
                          </template>
                          <v-date-picker
                            v-model="selectedDate"
                            @input="dateMenu = false"
                            no-title
                            scrollable
                          ></v-date-picker>
                        </v-menu>
                      </v-col>
                    </v-row>

                    <v-row dense class="mt-2">
                      <v-col cols="6" class="d-flex justify-end pr-1">
                        <v-btn
                          color="info"
                          small
                          @click="goToPreviousDay"
                          block
                        >
                          <v-icon left>fa-solid fa-chevron-left</v-icon>
                          Previous Day
                        </v-btn>
                      </v-col>
                      <v-col cols="6" class="d-flex justify-start pl-1">
                        <v-btn color="info" small @click="goToNextDay" block>
                          Next Day
                          <v-icon right>fa-solid fa-chevron-right</v-icon>
                        </v-btn>
                      </v-col>
                    </v-row>
                  </v-tab-item>

                  <v-tab-item>
                    <!-- Date Range Inputs -->
                    <v-row dense class="mt-5">
                      <v-col cols="12" md="6">
                        <v-menu
                          v-model="startDateMenu"
                          :close-on-content-click="false"
                          transition="scale-transition"
                          offset-y
                          min-width="auto"
                        >
                          <template v-slot:activator="{ on, attrs }">
                            <v-text-field
                              v-model="startDate"
                              label="Start Date"
                              prepend-icon="fa-solid fa-calendar-days"
                              readonly
                              outlined
                              dense
                              v-bind="attrs"
                              v-on="on"
                              :rules="[rules.required]"
                              hide-details="auto"
                            ></v-text-field>
                          </template>
                          <v-date-picker
                            v-model="startDate"
                            @input="startDateMenu = false"
                            no-title
                            scrollable
                          ></v-date-picker>
                        </v-menu>
                      </v-col>
                      <v-col cols="12" md="6">
                        <v-menu
                          v-model="endDateMenu"
                          :close-on-content-click="false"
                          transition="scale-transition"
                          offset-y
                          min-width="auto"
                        >
                          <template v-slot:activator="{ on, attrs }">
                            <v-text-field
                              v-model="endDate"
                              label="End Date"
                              prepend-icon="fa-solid fa-calendar-days"
                              readonly
                              outlined
                              dense
                              v-bind="attrs"
                              v-on="on"
                              :rules="[rules.required]"
                              hide-details="auto"
                            ></v-text-field>
                          </template>
                          <v-date-picker
                            v-model="endDate"
                            @input="endDateMenu = false"
                            no-title
                            scrollable
                          ></v-date-picker>
                        </v-menu>
                      </v-col>
                    </v-row>

                    <!--
                                            <v-row dense class="mt-4 mb-2">
                                              <v-col cols="12" class="mr-5">
                                                <v-slider
                                                  v-model="maxResults"
                                                  label="Max Time Slot Candidates to Find"
                                                  min="5"
                                                  max="100"
                                                  step="5"
                                                  thumb-label="always"
                                                  class="mt-6"
                                                  color="primary"
                                                  track-color="grey lighten-2"
                                                  hide-details
                                                ></v-slider>
                                              </v-col>
                                            </v-row>
                                          -->
                  </v-tab-item>
                </v-tabs-items>

                <!-- New Multi-select for Boolean Filters -->
                <v-row dense class="mt-5">
                  <v-col cols="12">
                    <v-select
                      v-model="selectedFilters"
                      :items="filterOptions"
                      label="Select desired filters"
                      multiple
                      chips
                      outlined
                      hide-details="auto"
                    ></v-select>
                  </v-col>
                </v-row>

                <v-row dense>
                  <v-col cols="12">
                    <v-select
                      v-model="selectedProhibitedYogas"
                      :items="yogaOptions"
                      label="Prohibited Yogas"
                      multiple
                      chips
                      outlined
                      hide-details="auto"
                    ></v-select>
                  </v-col>
                </v-row>

                <!-- New Multi-select for Nakshatras -->
                <v-row dense>
                  <v-col cols="12">
                    <v-select
                      v-model="selectedNakshatras"
                      :items="nakshatraOptions"
                      label="Nakshatra of Jataka(s) for whom Tarabala is Needed"
                      multiple
                      chips
                      outlined
                      hide-details="auto"
                      title="Select more than one if multiple jatakas are involved (e.g. wedding muhurta)"
                    ></v-select>
                  </v-col>
                </v-row>

                <v-row dense>
                  <v-col cols="12">
                    <v-select
                      v-model="selectedProhibitedNakshatras"
                      :items="nakshatraOptions"
                      label="Prohibited Nakshatras regardless of Tarabala"
                      multiple
                      chips
                      outlined
                      hide-details="auto"
                      title="For example, Pushya nakshatra for wedding muhurta"
                    ></v-select>
                  </v-col>
                </v-row>

                <!-- New Multi-select for Rashis -->
                <v-row dense>
                  <v-col cols="8">
                    <v-select
                      v-model="selectedRashis"
                      :items="rashiOptions"
                      label="Rashi of Jataka(s) for whom Chandrabala is Needed"
                      multiple
                      chips
                      outlined
                      hide-details="auto"
                      title="Select more than one if multiple jatakas are involved (e.g. wedding muhurta)"
                    ></v-select>
                  </v-col>
                  <v-col cols="4">
                    <strong>Bad Chandrabala Houses</strong>

                    <v-chip-group
                      v-model="selectedChandrabalaHouses"
                      multiple
                      active-class="primary--text"
                    >
                      <v-chip
                        v-for="number in [4, 8, 12]"
                        :key="number"
                        :value="number"
                        label
                        outlined
                        filter
                        color="primary"
                      >
                        {{ number }}
                      </v-chip>
                    </v-chip-group>
                  </v-col>
                </v-row>

                <v-row class="mt-4">
                  <v-col cols="12" class="d-flex justify-center">
                    <v-btn
                      color="primary"
                      large
                      @click="fetchAstroData()"
                      :disabled="!isFormValid || loadingData"
                    >
                      <v-icon center>fa-solid fa-magnifying-glass</v-icon>
                    </v-btn>
                  </v-col>
                </v-row>
              </v-card-text>
            </v-card>

            <v-overlay
              :value="loadingData"
              absolute
              opacity="0.7"
              color="grey lighten-3"
            >
              <v-progress-circular
                indeterminate
                size="64"
                color="primary"
              ></v-progress-circular>
              <div class="text-center mt-3" style="color: #1976d2">
                Searching... Please wait.
              </div>
            </v-overlay>

            <transition name="fade" mode="out-in">
              <div v-if="panchangaLoaded">
                <div class="info-grid mb-8">
                  <v-card class="info-card" elevation="2">
                    <v-card-title>
                      <v-icon left>fa-solid fa-sun</v-icon>
                      Sunrise Time
                    </v-card-title>
                    <v-card-text
                      >{{ julianDayToDate( panchangaData[0].begin.jd_utc,
                      "datetime") }}</v-card-text
                    >
                  </v-card>
                  <v-card class="info-card" elevation="2">
                    <v-card-title>
                      <v-icon left>fa-solid fa-moon</v-icon>
                      Tithi
                    </v-card-title>
                    <v-card-text
                      >{{ panchangaData[0].panchanga.uday_tithi }}</v-card-text
                    >
                  </v-card>
                  <v-card class="info-card" elevation="2">
                    <v-card-title>
                      <v-icon left>fa-solid fa-calendar</v-icon>
                      Wara
                    </v-card-title>
                    <v-card-text
                      >{{ panchangaData[0].panchanga.wara }}</v-card-text
                    >
                  </v-card>
                </div>

                <h3 v-if="panchangaData.length > 0" class="text-center mb-4">
                  Panchanga details by time span
                </h3>
                <!-- Changed to time-spans-list for vertical arrangement -->
                <div class="time-spans-list">
                  <v-card
                    v-for="(span, index) in panchangaData"
                    :key="index"
                    class="info-card time-span-card"
                    :class="{ 'inauspicious-card': hasDosha(span.panchanga.dosha) }"
                    elevation="2"
                  >
                    <v-card-title>
                      <v-icon left>fa-solid fa-clock</v-icon>
                      {{ julianDayToDate(span.begin.jd_utc, "datetime") }} - {{
                      julianDayToDate( span.end.jd_utc , "datetime")}}
                    </v-card-title>
                    <v-card-subtitle v-if="hasDosha(span.panchanga.dosha)">
                      <v-icon left> fa-solid fa-skull-crossbones </v-icon>
                      {{ doshaString(span.panchanga.dosha) }}
                    </v-card-subtitle>

                    <v-card-text>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'nakshatra') }"
                      >
                        <strong>Nakshatra:</strong> {{ span.panchanga.nakshatra
                        }}
                      </div>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'yoga') }"
                      >
                        <strong>Yoga:</strong> {{ span.panchanga.yoga }}
                      </div>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'karana') }"
                      >
                        <strong>Karana:</strong> {{ span.panchanga.karana }}
                      </div>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'true_tithi') }"
                      >
                        <strong>Tithi:</strong> {{ span.panchanga.true_tithi }}
                      </div>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'lagna') }"
                      >
                        <strong>Lagna:</strong> {{ span.panchanga.lagna }}
                      </div>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'chandra_rashi') }"
                      >
                        <strong>Chandra Rashi:</strong> {{
                        span.panchanga.chandra_rashi }}
                      </div>
                      <div
                        :class="{ 'greyed-out-text': isSameAsPrevious(span, index, 'surya_rashi') }"
                      >
                        <strong>Surya Rashi:</strong> {{
                        span.panchanga.surya_rashi }}
                      </div>

                      <!-- Removed the "View Chart" button -->
                    </v-card-text>
                  </v-card>
                </div>
              </div>
            </transition>

            <transition name="fade" mode="out-in">
              <div v-if="muhurtaLoaded">
                <!-- Sticky Error Alert -->
                <v-alert
                  v-if="muhurtaData.length==0"
                  type="warning"
                  transition="slide-y-transition"
                  prominent
                  border="left"
                >
                  Unable to find any matching options. Please remove some
                  filters and try again.
                  <br />
                  A common cause of "no results" is that if more than one janma
                  nakshatra and/or janma rashi are selected, there may not be
                  any combination possible to have tarabala/chandrabala.
                </v-alert>

                <h3 v-if="muhurtaData.length > 0" class="text-center mb-4">
                  Panchanga details for upcoming time spans that match the
                  filters provided
                </h3>
                <v-row
                  v-if="activeTab === 1 && muhurtaData.length > 0"
                  class="mb-4"
                  dense
                >
                  <v-col cols="12" class="d-flex justify-center">
                    <v-btn color="success" small @click="downloadCsv">
                      <v-icon left>fa-solid fa-download</v-icon>
                      Download Data as CSV
                    </v-btn>
                  </v-col>
                </v-row>

                <!-- Changed to time-spans-list for vertical arrangement -->
                <div class="time-spans-list">
                  <v-card
                    v-for="(span, index) in muhurtaData"
                    :key="index"
                    class="info-card time-span-card"
                    :class="{ 'inauspicious-card': hasDosha(span.panchanga.dosha) }"
                    elevation="2"
                  >
                    <v-card-title>
                      <v-icon left>fa-solid fa-calendar-days</v-icon>
                      <span class="mr-4"
                        >{{ julianDayToDate(span.begin.jd_utc, "date") }}</span
                      >
                      <v-icon left>fa-solid fa-clock</v-icon>
                      <span
                        >{{ julianDayToDate(span.begin.jd_utc, "time") }} - {{
                        julianDayToDate(span.end.jd_utc, "time") }}</span
                      >
                    </v-card-title>
                    <v-card-subtitle v-if="hasDosha(span.panchanga.dosha)">
                      <v-icon left> fa-solid fa-skull-crossbones </v-icon>
                      {{ doshaString(span.panchanga.dosha) }}
                    </v-card-subtitle>

                    <v-card-text>
                      <div>
                        <strong>Nakshatra:</strong> {{ span.panchanga.nakshatra
                        }}
                      </div>
                      <div>
                        <strong>Yoga:</strong> {{ span.panchanga.yoga }}
                      </div>
                      <div>
                        <strong>Karana:</strong> {{ span.panchanga.karana }}
                      </div>

                      <div>
                        <strong>Uday Tithi:</strong> {{
                        span.panchanga.uday_tithi }}
                      </div>
                      <div>
                        <strong>True Tithi:</strong> {{
                        span.panchanga.true_tithi }}
                      </div>
                      <div>
                        <strong>Lagna:</strong> {{ span.panchanga.lagna }}
                      </div>
                      <div>
                        <strong>Chandra Rashi:</strong> {{
                        span.panchanga.chandra_rashi }}
                      </div>
                      <div>
                        <strong>Surya Rashi:</strong> {{
                        span.panchanga.surya_rashi }}
                      </div>
                    </v-card-text>
                  </v-card>
                </div>
              </div>
              <v-card
                v-if="fetchAttempted && !(panchangaLoaded || muhurtaLoaded)"
                class="pa-4 text-center"
                elevation="2"
              >
                <v-card-text>
                  <v-icon size="48" color="warning"
                    >fa-solid fa-circle-exclamation</v-icon
                  >
                  <p class="mt-2">
                    Something went wrong. Please try again later.
                  </p>
                </v-card-text>
              </v-card>
              <v-card
                v-if="cityNotFound"
                class="pa-4 text-center mt-4"
                elevation="2"
              >
                <v-card-text>
                  <v-icon size="48" color="error"
                    >fa-solid fa-circle-xmark</v-icon
                  >
                  <p class="mt-2">
                    City not found. Please try a different city name or enter
                    coordinates manually.
                  </p>
                </v-card-text>
              </v-card>
            </transition>
          </v-container>
        </v-main>
        <v-footer
          app
          padless
          color="blue-grey darken-4"
          class="white--text justify-center py-2"
        >
          <span>
            Developed by Alok Parlikar based on the concepts taught in the
            Panchanga and Muhurta course (2025) by Shri Vedanjanam ji
          </span>
        </v-footer>

        <!-- Removed Kundali Chart Dialog -->
      </v-app>
    </div>

    <script>
      new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        data: () => ({
          latitude: null,
          longitude: null,
          cityName: "Pune", // New data property for city name
          foundPlaceName: "",
          activeTab: 0,

          selectedDate: new Date().toISOString().substr(0, 10), // Default to today's date
          dateMenu: false,

          startDate: new Date().toISOString().substr(0, 10), // Default to today's date
          startDateMenu: false,
          endDate: new Date(new Date().setMonth(new Date().getMonth() + 1))
            .toISOString()
            .substr(0, 10), // Default to 1 month from now
          endDateMenu: false,
          maxResults: 100,

          timezone: 5.5,
          astroData: {
            sunriseTime: "",
            tithi: "",
            rahuKala: "",
            timeSpans: [], // Array to hold time-span specific data
          },
          loadingData: false,
          panchangaData: {},
          panchangaLoaded: false,
          muhurtaLoaded: false,
          fetchAttempted: false, // To show message only after an attempt
          loadingCoordinates: false, // New loading state for coordinate fetching
          cityNotFound: false, // New state for city not found error
          showMoshierWarning: false, // New: Controls visibility of the Moshier warning
          showError: false,
          selectedFilters: [0, 1, 2, 3, 4, 5, 9],
          filterOptions: [
            // New: Options for nakshatra multi-select
            { text: "No Krakach Yoga", value: 0 },
            { text: "No Rikta Tithi", value: 1 },
            { text: "No Sthir Karana", value: 2 },
            { text: "No Vishti Karana", value: 3 },
            { text: "No Vish Ghati", value: 4 },
            { text: "No Ushna Ghati", value: 5 },
            { text: "No Sthir Lagna", value: 6 },
            { text: "No Char Lagna", value: 7 },
            { text: "No Dvi Lagna", value: 8 },
            { text: "Sun not in Jup Sign", value: 9 },
            { text: "No Ekargala Dosha", value: 10 },
          ],

          selectedNakshatras: [], // New: Array to store selected nakshatras
          selectedProhibitedNakshatras: [], // New: Array to store selected prohibited nakshatras
          nakshatraOptions: [
            // New: Options for nakshatra multi-select
            { text: "Ashwini", value: 0 },
            { text: "Bharani", value: 1 },
            { text: "Krittika", value: 2 },
            { text: "Rohini", value: 3 },
            { text: "Mrigashira", value: 4 },
            { text: "Ardra", value: 5 },
            { text: "Punarvasu", value: 6 },
            { text: "Pushya", value: 7 },
            { text: "Ashlesha", value: 8 },
            { text: "Magha", value: 9 },
            { text: "Purva Phalguni", value: 10 },
            { text: "Uttara Phalguni", value: 11 },
            { text: "Hasta", value: 12 },
            { text: "Chitra", value: 13 },
            { text: "Swati", value: 14 },
            { text: "Vishakha", value: 15 },
            { text: "Anuradha", value: 16 },
            { text: "Jyeshtha", value: 17 },
            { text: "Moola", value: 18 },
            { text: "Purva Ashadha", value: 19 },
            { text: "Uttara Ashadha", value: 20 },
            { text: "Sravana", value: 21 },
            { text: "Dhanishtha", value: 22 },
            { text: "Shatabhisha", value: 23 },
            { text: "Purva Bhadrapada", value: 24 },
            { text: "Uttara Bhadrapada", value: 25 },
            { text: "Revati", value: 26 },
          ],

          selectedChandrabalaHouses: [4, 8, 12],
          selectedRashis: [], // New: Array to store selected rashis
          rashiOptions: [
            // New: Options for rashi multi-select
            { text: "Aries", value: 0 },
            { text: "Taurus", value: 1 },
            { text: "Gemini", value: 2 },
            { text: "Cancer", value: 3 },
            { text: "Leo", value: 4 },
            { text: "Virgo", value: 5 },
            { text: "Libra", value: 6 },
            { text: "Scorpio", value: 7 },
            { text: "Sagittarius", value: 8 },
            { text: "Capricorn", value: 9 },
            { text: "Aquarius", value: 10 },
            { text: "Pisces", value: 11 },
          ],

          selectedProhibitedYogas: [],
          yogaOptions: [
            { text: "Vishkambha", value: 0 },
            { text: "Priti", value: 1 },
            { text: "Ayushman", value: 2 },
            { text: "Saubhagya", value: 3 },
            { text: "Shobhana", value: 4 },
            { text: "Atiganda", value: 5 },
            { text: "Sukarma", value: 6 },
            { text: "Dhriti", value: 7 },
            { text: "Shoola", value: 8 },
            { text: "Ganda", value: 9 },
            { text: "Vriddhi", value: 10 },
            { text: "Dhruva", value: 11 },
            { text: "Vyaghata", value: 12 },
            { text: "Harshana", value: 13 },
            { text: "Vajra", value: 14 },
            { text: "Siddhi", value: 15 },
            { text: "Vyateepata", value: 16 },
            { text: "Variyan", value: 17 },
            { text: "Parigha", value: 18 },
            { text: "Shiva", value: 19 },
            { text: "Siddha", value: 20 },
            { text: "Sadhya", value: 21 },
            { text: "Shubha", value: 22 },
            { text: "Shukla", value: 23 },
            { text: "Brahma", value: 24 },
            { text: "Indra", value: 25 },
            { text: "Vaidhriti", value: 26 },
          ],
          rules: {
            required: (value) => !!value || "Required.",
            number: (value) => !isNaN(parseFloat(value)) || "Must be a number.",
          },
        }),
        computed: {
          // Computed property to check if all form fields are valid
          isFormValid() {
            const commonValid =
              !isNaN(parseFloat(this.latitude)) &&
              !isNaN(parseFloat(this.longitude)) &&
              !isNaN(parseFloat(this.timezone));

            if (this.activeTab === 0) {
              // Single Day Tab
              return commonValid && !!this.selectedDate;
            } else {
              // Date Range Tab
              return (
                commonValid &&
                !!this.startDate &&
                !!this.endDate &&
                !isNaN(parseInt(this.maxResults)) &&
                parseInt(this.maxResults) > 0
              );
            }
          },
        },
        methods: {
          async fetchCoordinatesForCity() {
            this.loadingCoordinates = true;
            this.cityNotFound = false; // Reset error message
            this.panchangaLoaded = false; // Clear previous astro data
            this.muhurtaLoaded = false;
            this.foundPlaceName = "";

            if (!this.cityName) {
              this.loadingCoordinates = false;
              return;
            }

            // OpenStreetMap Nominatim API endpoint
            // IMPORTANT: Please respect Nominatim's Usage Policy: https://operations.osmfoundation.org/policies/nominatim/
            // - Do not abuse the service (e.g., no heavy batch geocoding).
            // - Provide a meaningful User-Agent header (e.g., your app name or email) for identification.
            // - Cache results to reduce repeated requests.
            const nominatimApiUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(this.cityName)}&format=json&limit=1`;

            console.log(
              `Fetching coordinates from Nominatim for city: ${this.cityName}`,
            );

            try {
              const response = await fetch(nominatimApiUrl, {
                headers: {
                  // IMPORTANT: Replace 'YourAppName/1.0 (your.email@example.com)' with your actual app name and contact email.
                  "User-Agent": "Panchanga-Muhurta/1.0 (alok@parlikar.com)",
                },
              });
              const data = await response.json();

              if (data && data.length > 0) {
                this.latitude = parseFloat(data[0].lat);
                this.longitude = parseFloat(data[0].lon);
                this.foundPlaceName = data[0].display_name;
                this.cityNotFound = false;
              } else {
                this.latitude = null;
                this.longitude = null;
                this.foundPlaceName = "";
                this.cityNotFound = true; // Show city not found message
              }
            } catch (error) {
              console.error("Error fetching coordinates:", error);
              this.latitude = null;
              this.longitude = null;
              this.foundPlaceName = "";
              this.cityNotFound = true; // Show city not found message due to error
            } finally {
              this.loadingCoordinates = false;
            }
          },
          updateDateAndFetch(daysOffset) {
            const currentDate = new Date(this.selectedDate);
            currentDate.setDate(currentDate.getDate() + daysOffset);
            this.selectedDate = currentDate.toISOString().substr(0, 10);
            this.fetchAstroData(0); // Automatically fetch data for the new date
          },
          goToPreviousDay() {
            this.updateDateAndFetch(-1);
          },
          goToNextDay() {
            this.updateDateAndFetch(1);
          },
          julianDayToDate(jdn, mode) {
            // Julian Day Number to Gregorian calendar date
            let J = jdn + 0.5;
            let j = Math.floor(J);
            let f = J - j;
            let A;

            if (j >= 2299161) {
              let alpha = Math.floor((j - 1867216.25) / 36524.25);
              A = j + 1 + alpha - Math.floor(alpha / 4);
            } else {
              A = j;
            }

            let B = A + 1524;
            let C = Math.floor((B - 122.1) / 365.25);
            let D = Math.floor(365.25 * C);
            let E = Math.floor((B - D) / 30.6001);

            let day = B - D - Math.floor(30.6001 * E) + f;
            let month = E < 14 ? E - 1 : E - 13;
            let year = month > 2 ? C - 4716 : C - 4715;

            // Extract hours, minutes, seconds from fractional day
            let dayFraction = day % 1;
            let totalSeconds = Math.floor(dayFraction * 86400);
            let hours = Math.floor(totalSeconds / 3600);
            let minutes = Math.floor((totalSeconds % 3600) / 60);
            let seconds = totalSeconds % 60;

            // Floor the day to get the integer day
            let dayInt = Math.floor(day);

            // Create a UTC date
            let utcDate = new Date(
              Date.UTC(year, month - 1, dayInt, hours, minutes, seconds),
            );

            // Apply timezone offset (in milliseconds)
            let offsetMillis = this.timezone * 60 * 60 * 1000;
            let localDate = new Date(utcDate.getTime() + offsetMillis);

            return this.formatDateTime(localDate, mode);
          },
          formatDateTime(date, mode) {
            const pad = (num) => String(num).padStart(2, "0");

            const day = pad(date.getUTCDate()); // Local day
            const month = pad(date.getUTCMonth() + 1); // Local month (0-based)
            const year = date.getUTCFullYear(); // Local year

            const hours = pad(date.getUTCHours()); // Local hours
            const minutes = pad(date.getUTCMinutes()); // Local minutes
            const seconds = pad(date.getUTCSeconds()); // Local seconds

            const date_str = `${day}-${month}-${year}`;
            const time_str = `${hours}:${minutes}:${seconds}`;
            const datetime_str = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;

            if (mode == "date") return date_str;
            if (mode == "time") return time_str;
            if (mode == "datetime") return datetime_str;

            return;
          },

          isSameAsPrevious(currentSpan, index, field) {
            if (index === 0 || !this.panchangaData[index - 1]) {
              return false; // First item or no previous item
            }
            return (
              currentSpan.panchanga[field] ===
              this.panchangaData[index - 1].panchanga[field]
            );
          },
          downloadCsv() {
            if (!this.muhurtaData || this.muhurtaData.length === 0) {
              console.warn("No data to download for CSV.");
              return;
            }

            const headers = [
              "Begin Time",
              "End Time",
              "Nakshatra",
              "Yoga",
              "Karana",
              "Uday Tithi",
              "True Tithi",
              "Lagna",
              "Chandra Rashi",
              "Surya Rashi",
            ];
            const rows = this.muhurtaData.map((span) => [
              this.julianDayToDate(span.begin.jd_utc, "datetime"),
              this.julianDayToDate(span.end.jd_utc, "datetime"),
              span.panchanga.nakshatra,
              span.panchanga.yoga,
              span.panchanga.karana,
              span.panchanga.uday_tithi,
              span.panchanga.true_tithi,
              span.panchanga.lagna,
              span.panchanga.chandra_rashi,
              span.panchanga.surya_rashi,
            ]);

            let csvContent = headers.join(",") + "\n";
            rows.forEach((row) => {
              csvContent += row.map((field) => `"${field}"`).join(",") + "\n"; // Enclose fields in quotes
            });

            const blob = new Blob([csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            const link = document.createElement("a");
            if (link.download !== undefined) {
              // Feature detection for download attribute
              const url = URL.createObjectURL(blob);
              link.setAttribute("href", url);
              link.setAttribute("download", "muhurta_data.csv");
              link.style.visibility = "hidden";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
            } else {
              // Fallback for browsers that do not support the download attribute
              console.error(
                "Your browser does not support downloading files directly. Please copy the data manually.",
              );
              // You might want to display the CSV content in a textarea for manual copy
              // or show a message to the user.
            }
          },
          fetchAstroData(mode) {
            this.cityNotFound = false; // Hide city not found message when fetching astro data

            this.panchangaLoaded = false;
            this.muhurtaLoaded = false;
            this.fetchAttempted = false;
            this.loadingData = true;

            if (!this.isFormValid) {
              this.panchangaLoaded = false;
              this.muhurtaLoaded = false;
              return; // Stop if form is not valid
            }

            console.log("here");
            this.panchangaData = {};
            console.log(this.panchangaData);

            var startDate = 0;
            if (this.activeTab == 0) {
              startDate = this.selectedDate;
            } else {
              startDate = this.startDate;
            }

            // build JSON for the input.
            inputs = {
              lat: this.latitude,
              lon: this.longitude,
              start_date: startDate,
              end_date: this.endDate,
              max_results: this.maxResults,

              tz: this.timezone,
              mode: this.activeTab,
              filters: {
                no_krakach_yoga: this.selectedFilters.indexOf(0) != -1,
                no_rikta_tithi: this.selectedFilters.indexOf(1) != -1,
                no_sthir_karan: this.selectedFilters.indexOf(2) != -1,
                no_vishti_karan: this.selectedFilters.indexOf(3) != -1,
                no_nakshatra_vish_ghati: this.selectedFilters.indexOf(4) != -1,
                no_nakshatra_ushna_ghati: this.selectedFilters.indexOf(5) != -1,
                no_sthir_lagna: this.selectedFilters.indexOf(6) != -1,
                no_chara_lagna: this.selectedFilters.indexOf(7) != -1,
                no_dvi_lagna: this.selectedFilters.indexOf(8) != -1,
                sun_not_in_jup_sign: this.selectedFilters.indexOf(9) != -1,
                no_ekargala: this.selectedFilters.indexOf(10) != -1,

                good_tarabala_for: this.selectedNakshatras,
                prohibited_nakshatra: this.selectedProhibitedNakshatras,
                prohibited_yoga: this.selectedProhibitedYogas,
                good_chandrabala_for: this.selectedRashis,
                bad_chandrabala_houses: this.selectedChandrabalaHouses,
              },
            };

            console.log(inputs);

            getPanchanga(JSON.stringify(inputs)).then((response) => {
              this.fetchAttempted = true;
              this.loadingData = false;
              console.log(response);
              resp = JSON.parse(response);
              if (resp.err) {
                console.log(resp.err);
                this.showError = true;
              } else {
                console.log("here2" + resp.data);
                if (this.activeTab == 0) {
                  this.panchangaData = resp.data;
                  this.panchangaLoaded = true;
                }
                if (this.activeTab == 1) {
                  this.muhurtaData = resp.data;
                  this.muhurtaLoaded = true;
                }
              }
            });

            // Log selected Nakshatras and Rashis for backend integration
            //console.log("Selected Nakshatras:", this.selectedNakshatras);
            //console.log("Selected Rashis:", this.selectedRashis);

            // Using simulated data for astronomical calculations
            console.log(
              `Fetching data for Lat: ${this.latitude}, Lon: ${this.longitude}, Date: ${this.selectedDate}`,
            );
          },
          hasDosha(dosha) {
            for (prop in dosha) {
              if (dosha[prop]) return true;
            }
          },
          doshaString(dosha) {
            var out = "";
            var i = 0;
            for (prop in dosha) {
              if (dosha[prop]) {
                if (i > 0) {
                  out = out + "   |   ";
                }
                out = out + prop;
                i = i + 1;
              }
            }
            return out;
          },
        },
        mounted() {
          // Initial fetch of coordinates on load
          this.fetchCoordinatesForCity();
          setTimeout(() => {
            isSwiephAvailable().then((response) => {
              console.log(response);
              if (response == 0) this.showMoshierWarning = true;
            });
          }, 2000);
        },
      });
    </script>
  </body>
</html>
